## Manage trust and authentication

This article shows you how to manage trusted issuers in the system and modify the expected value of the audience. It assumes you are familiar with the concepts discussed in [Authentication, authorization, and trust](../backgound/authentication-authorization-and-trust.md).

### Trusted issuers

You can manage the trusted issuers in the system with the `yarn ops issuer` command. For example, you can see the list of trusted issuers for your deployment with:

```bash
yarn ops issuer ls
```

Please refer to the [LetsGo CLI](../reference/letsgo-cli.md) for details.

#### Third-party issuers

To enable trust to a third-party access token issuer, you need two pieces of information:

1. The issuer identifier, which is to the value of the `iss` claim in the access tokens created by that issuer.
1. The issuer's [JWKS](https://datatracker.ietf.org/doc/html/rfc7517) endpoint.

With this information, you can enable trust in that issuer by running the following command:

```bash
yarn ops issuer add --issuer {issuer-identifier} --jwks {jwks-endpoint}
```

The [Setting up authentication with Auth0](../tutorials/setting-up-authentication-with-auth0.md) walks you through the process of configuring Auth0 as a trusted third-party issuer of JWT tokens.

#### Built-in PKI issuers

You add a new built-in issuer of JWT tokens that uses a generated public/private key pair stored in your system with:

```bash
yarn ops issuer add -pki-create
```

You can have multiple trusted PKI issuers configured in the system, which enables you to roll over the PKI credentials without downtime.

One of the PKI issuers can be designated as _active_. While tokens from any of the built-in issuers will be accepted as valid by the system, the active issuer is used to create new access tokens internally.

When you run the `yarn ops issuer add --pki-create`, the newly created issuer is designated as active. You can also create a new PKI issuer without designating it as active with:

```bash
yarn ops issuer add --pki-create-only
```

Once you have multiple built-in PKI issuers in the system, you can change the one that is active with:

```bash
yarn ops issuer add --pki-activate {issuerId}
```

To see which of the built-in issuers is active, run

```bash
yarn ops issuer ls
```

**NOTE** When a brand new LetsGo deployment is created for the first time, one built-in issuer is created for you and designated active.

### Creating ad-hoc access tokens

One use of active PKI issuer is to create ad-hoc JWT access tokens for testing. You can do this using the CLI with:

```bash
yarn ops jwt
```

You can conveniently generate such access tokens on the fly when making HTTP calls, e.g.:

```bash
curl http://localhost:3001/v1/foo/bar -H "Authorization: Bearer $(yarn -s ops jwt)"
```

**NOTE** Notice the `-s` option passed to `yarn` above to disable any output generated by `yarn` itself.

You can also create those access tokens in code using the `createJwt` function exposed by the `@letsgo/trust` package:

```typescript
import { createJwt } from "@letsgo/trust";

const accessToken = await createJwt();
```

### Audience

For the access token to be trusted, the `aud` claim must match the value that your deployment expects. LetsGo uses a logical audience of `letsgo:service` by default. You can change this value to be something else using the `LETSGO_API_AUDIENCE` configuration property for the _API_ component, and the `AUTH0_AUDIENCE` configuration property for the _web_ component (assuming you have [configured Auth0 as your trusted issuer](../tutorials/setting-up-authentication-with-auth0.md)).

### Related topics

[Authentication, authorization, and trust](../backgound/authentication-authorization-and-trust.md)  
[Setting up authentication with Auth0](../tutorials/setting-up-authentication-with-auth0.md)  
[Developing the API](./develop-the-api.md)  
[Developing the worker](./develop-the-worker.md)  
[LetsGo CLI](../reference/letsgo-cli.md)  
[@letsgo/trust](../reference/letsgo-trust/README.md)
